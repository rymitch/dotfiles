#!/usr/bin/env bash

if [ "$1" == "" ]; then
  echo Syntax: bkdir DIR
  exit 1
fi

DIR=$1

if [ "$ARCH" == "" ]; then
  echo Error: \$ARCH must be defined.
  exit 1
fi

if [ ! -d $ARCH ]; then
  echo Error: $ARCH does not exist or is not a directory.
  exit 1
fi

if [ ! -d $DIR ]; then
  echo Error: $DIR does not exist or is not a directory.
  exit 1
fi

case "$DIR" in
*/*)
  echo Error: Input directory $DIR may not contain a slash.
  exit 1
  ;;
esac

NAME=`date "+%Y%m%d.%H%M%S"`
WORK=$NAME.tmp

rsync -azP \
  --delete \
  --delete-excluded \
  --link-dest=$ARCH/$DIR/current \
  $DIR/ \
  $ARCH/$DIR/$WORK \
  && mv $ARCH/$DIR/$WORK $ARCH/$DIR/$NAME \
  && rm -f $ARCH/$DIR/current \
  && ln -s $NAME $ARCH/$DIR/current

echo Finished at `date +%H:%M:%S`.

#/usr/bin/env bash

# Create a temporary working directory.

tempdir=$(mktemp -d)

# Create the Emacs script to reformat the file.

escript=$tempdir/$(basename $0).$(date +%Y%m%d.%H%M%S)
cat >$escript <<EOF
(defun emacs-format-function ()
   "Format the whole buffer."
   (indent-region (point-min) (point-max) nil)
   (untabify (point-min) (point-max))
   (save-buffer)
)
EOF

# Copy stdin to a temporary file. Emacs can't deal with stdin.

working=$tempdir/$(basename $0).$(date +%Y%m%d.%H%M%S).ss
while read input; do
  echo $input >>$working
done

# Call Emacs in batch mode to reformat the file.

emacs -batch $working --user=`whoami` -l $escript -f emacs-format-function >/dev/null 2>&1

# Send the results to stdout.

cat $working

# Clean up the working directory.

rm -rf $tempdir
